<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>ä¿è‚²åœ’æ—¥èªŒç”Ÿæˆãƒ„ãƒ¼ãƒ«</title>
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <style>
        /* iPadã«æœ€é©åŒ–ã—ãŸã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding: 0;
            margin: 0;
            background-color: #f5f5f5;
            -webkit-user-select: none; /* Safari */
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            background-color: #4a6da7;
            color: white;
            padding: 15px 20px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
            font-size: 16px;
        }
        
        input[type="text"], 
        input[type="date"], 
        input[type="password"],
        select {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 18px;
            -webkit-appearance: none;
        }
        
        /* iPadã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
        select {
            background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='24' viewBox='0 0 24 24' width='24' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }
        
        /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
        button {
            background-color: #4a8f69;
            color: white;
            border: none;
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            width: 100%;
            margin-top: 20px;
            cursor: pointer;
        }
        
        button:active {
            background-color: #3a7355;
            transform: scale(0.98);
        }
        
        /* ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒœã‚¿ãƒ³ */
        .quick-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .quick-input-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            color: #333;
        }
        
        .quick-input-btn:active {
            background-color: #e0e0e0;
            transform: scale(0.98);
        }
        
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .result-area {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
        }
        
        .result-text {
            font-size: 18px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
        }
        
        .result-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .action-btn {
            background-color: #4a6da7;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            width: 48%;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 30px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(74, 109, 167, 0.2);
            border-radius: 50%;
            border-top-color: #4a6da7;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }
        
        .login-card {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        
        .login-title {
            font-size: 24px;
            color: #4a6da7;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 15px;
            font-weight: bold;
        }
        
        /* éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ */
        .voice-input-btn {
            position: absolute;
            right: 15px;
            top: 45px;
            background: none;
            border: none;
            font-size: 24px;
            color: #4a6da7;
            width: auto;
            padding: 5px;
            margin: 0;
        }
        
        /* ä¿å­˜ã—ãŸæ—¥èªŒãƒªã‚¹ãƒˆ */
        .saved-journals {
            margin-top: 20px;
        }
        
        .journal-item {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .journal-date {
            font-weight: bold;
            color: #4a6da7;
        }
        
        .journal-preview {
            margin-top: 10px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        .tab-navigation {
            display: flex;
            background-color: white;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            text-align: center;
            padding: 15px;
            color: #777;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .tab-btn.active {
            color: #4a6da7;
        }
        
        .tab-icon {
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .content-area {
            margin-bottom: 80px; /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã•åˆ†ã®ä½™ç™½ */
        }
        
        /* iPadã®ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ä¸‹éƒ¨ã®ä½™ç™½ã‚’ç¢ºä¿ */
        @supports (-webkit-touch-callout: none) {
            .content-area {
                margin-bottom: 100px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-container" id="login-screen">
        <div class="login-card">
            <h1 class="login-title">ä¿è‚²åœ’æ—¥èªŒä½œæˆãƒ„ãƒ¼ãƒ«</h1>
            <div class="form-group">
                <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>
            <button id="login-btn">ãƒ­ã‚°ã‚¤ãƒ³</button>
            <div class="error-message" id="login-error"></div>
        </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª -->
    <div id="app" style="display: none;">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="app-header">ä¿è‚²åœ’æ—¥èªŒä½œæˆãƒ„ãƒ¼ãƒ«</div>
        
        <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
        <div class="content-area">
            <!-- æ—¥èªŒä½œæˆã‚¿ãƒ– -->
            <div class="container" id="create-tab">
                <div class="form-card">
                    <div class="form-group">
                        <label for="date">æ—¥ä»˜</label>
                        <input type="date" id="date">
                    </div>
                    
                    <div class="form-group">
                        <label for="weather">å¤©å€™</label>
                        <select id="weather">
                            <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
                            <option value="æ›‡ã‚Š">æ›‡ã‚Š</option>
                            <option value="é›¨">é›¨</option>
                            <option value="é›ª">é›ª</option>
                            <option value="æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š">æ™´ã‚Œæ™‚ã€…æ›‡ã‚Š</option>
                            <option value="æ›‡ã‚Šæ™‚ã€…æ™´ã‚Œ">æ›‡ã‚Šæ™‚ã€…æ™´ã‚Œ</option>
                            <option value="æ›‡ã‚Šæ™‚ã€…é›¨">æ›‡ã‚Šæ™‚ã€…é›¨</option>
                            <option value="é›¨æ™‚ã€…æ›‡ã‚Š">é›¨æ™‚ã€…æ›‡ã‚Š</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="class-type">ã‚¯ãƒ©ã‚¹</label>
                        <select id="class-type">
                            <option value="0æ­³å…">0æ­³å…ã‚¯ãƒ©ã‚¹</option>
                            <option value="1æ­³å…">1æ­³å…ã‚¯ãƒ©ã‚¹</option>
                            <option value="2æ­³å…">2æ­³å…ã‚¯ãƒ©ã‚¹</option>
                            <option value="3æ­³å…">3æ­³å…ã‚¯ãƒ©ã‚¹</option>
                            <option value="4æ­³å…">4æ­³å…ã‚¯ãƒ©ã‚¹</option>
                            <option value="5æ­³å…">5æ­³å…ã‚¯ãƒ©ã‚¹</option>
                            <option value="ç•°å¹´é½¢">ç•°å¹´é½¢æ··åˆã‚¯ãƒ©ã‚¹</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="activities">ä¸»ãªæ´»å‹•å†…å®¹</label>
                        <div class="relative-wrapper">
                            <input type="text" id="activities" placeholder="ä¸»ãªæ´»å‹•ã‚’å…¥åŠ›...">
                            <button class="voice-input-btn" id="voice-activities">ğŸ¤</button>
                        </div>
                        
                        <div class="quick-inputs">
                            <button class="quick-input-btn" data-target="activities">è‡ªç”±éŠã³</button>
                            <button class="quick-input-btn" data-target="activities">è£½ä½œæ´»å‹•</button>
                            <button class="quick-input-btn" data-target="activities">ãŠæ•£æ­©</button>
                            <button class="quick-input-btn" data-target="activities">æ°´éŠã³</button>
                            <button class="quick-input-btn" data-target="activities">é‹å‹•éŠã³</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="special-events">ç‰¹åˆ¥ãªå‡ºæ¥äº‹ãƒ»è¡Œäº‹</label>
                        <input type="text" id="special-events" placeholder="ç‰¹åˆ¥ãªå‡ºæ¥äº‹ãŒã‚ã‚Œã°...">
                        
                        <div class="quick-inputs">
                            <button class="quick-input-btn" data-target="special-events">èª•ç”Ÿæ—¥ä¼š</button>
                            <button class="quick-input-btn" data-target="special-events">é¿é›£è¨“ç·´</button>
                            <button class="quick-input-btn" data-target="special-events">èº«ä½“æ¸¬å®š</button>
                            <button class="quick-input-btn" data-target="special-events">å¥åº·è¨ºæ–­</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="children-mood">å­ã©ã‚‚ãŸã¡ã®æ§˜å­</label>
                        <div class="relative-wrapper">
                            <input type="text" id="children-mood" placeholder="å­ã©ã‚‚ãŸã¡ã®æ§˜å­...">
                            <button class="voice-input-btn" id="voice-mood">ğŸ¤</button>
                        </div>
                        
                        <div class="quick-inputs">
                            <button class="quick-input-btn" data-target="children-mood">å…ƒæ°—ã„ã£ã±ã„</button>
                            <button class="quick-input-btn" data-target="children-mood">é›†ä¸­ã—ã¦</button>
                            <button class="quick-input-btn" data-target="children-mood">æ¥½ã—ãã†ã«</button>
                            <button class="quick-input-btn" data-target="children-mood">å”åŠ›ã—ã¦</button>
                            <button class="quick-input-btn" data-target="children-mood">èˆˆå‘³æ´¥ã€…</button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="keywords">ãã®ä»–ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
                        <input type="text" id="keywords" placeholder="é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰...">
                    </div>
                    
                    <div class="form-group">
                        <label for="length">æ–‡ç« ã®é•·ã•</label>
                        <select id="length">
                            <option value="100">çŸ­ã‚ (ç´„100å­—)</option>
                            <option value="150" selected>æ¨™æº– (ç´„150å­—)</option>
                            <option value="200">é•·ã‚ (ç´„200å­—)</option>
                        </select>
                    </div>
                    
                    <button id="generate-btn">æ—¥èªŒã‚’ç”Ÿæˆã™ã‚‹</button>
                </div>
                
                <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>æ—¥èªŒã‚’ç”Ÿæˆä¸­...</p>
                </div>
                
                <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div class="result-area" id="result-area">
                    <div class="result-text" id="result-text"></div>
                    <div class="result-actions">
                        <button class="action-btn" id="copy-btn">ã‚³ãƒ”ãƒ¼</button>
                        <button class="action-btn" id="save-btn">ä¿å­˜</button>
                    </div>
                </div>
            </div>
            
            <!-- ä¿å­˜æ¸ˆã¿æ—¥èªŒã‚¿ãƒ– -->
            <div class="container" id="saved-tab" style="display: none;">
                <h2>ä¿å­˜ã—ãŸæ—¥èªŒ</h2>
                <div class="saved-journals" id="saved-journals-list">
                    <!-- ä¿å­˜ã—ãŸæ—¥èªŒãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
            
            <!-- è¨­å®šã‚¿ãƒ– -->
            <div class="container" id="settings-tab" style="display: none;">
                <div class="form-card">
                    <h2>è¨­å®š</h2>
                    <div class="form-group">
                        <label for="api-key">OpenAI APIã‚­ãƒ¼</label>
                        <input type="password" id="api-key" placeholder="sk-...">
                        <p class="hint">â€»APIã‚­ãƒ¼ã¯ã“ã®ç«¯æœ«ã«ã®ã¿ä¿å­˜ã•ã‚Œã€å¤–éƒ¨ã«é€ä¿¡ã•ã‚Œã¾ã›ã‚“</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="offline-mode">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰</label>
                        <select id="offline-mode">
                            <option value="auto">è‡ªå‹• (æ¥ç¶šçŠ¶æ³ã«å¿œã˜ã¦åˆ‡æ›¿)</option>
                            <option value="always">å¸¸ã«ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ (ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã¿)</option>
                            <option value="never">å¸¸ã«ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ (APIä½¿ç”¨)</option>
                        </select>
                    </div>
                    
                    <button id="save-settings">è¨­å®šã‚’ä¿å­˜</button>
                </div>
            </div>
        </div>
        
        <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="tab-navigation">
            <div class="tab-btn active" data-tab="create-tab">
                <div class="tab-icon">âœï¸</div>
                <div>ä½œæˆ</div>
            </div>
            <div class="tab-btn" data-tab="saved-tab">
                <div class="tab-icon">ğŸ“‹</div>
                <div>ä¿å­˜æ¸ˆã¿</div>
            </div>
            <div class="tab-btn" data-tab="settings-tab">
                <div class="tab-icon">âš™ï¸</div>
                <div>è¨­å®š</div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§æ¤œè¨¼ã™ã‚‹ã‹ã€ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã§ç®¡ç†ï¼‰
            const correctPassword = 'hoikuen2025';
            
            // DOMå‚ç…§
            const loginScreen = document.getElementById('login-screen');
            const app = document.getElementById('app');
            const loginBtn = document.getElementById('login-btn');
            const loginError = document.getElementById('login-error');
            const generateBtn = document.getElementById('generate-btn');
            const copyBtn = document.getElementById('copy-btn');
            const saveBtn = document.getElementById('save-btn');
            const saveSettingsBtn = document.getElementById('save-settings');
            const tabButtons = document.querySelectorAll('.tab-btn');
            const quickInputButtons = document.querySelectorAll('.quick-input-btn');
            const voiceButtons = document.querySelectorAll('.voice-input-btn');
            
            // æ—¥ä»˜ã«ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('date').valueAsDate = new Date();
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã¨APIæƒ…å ±ã‚’å–å¾—
            const apiKey = localStorage.getItem('openai_api_key') || '';
            document.getElementById('api-key').value = apiKey;
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
            const isLoggedIn = localStorage.getItem('logged_in');
            if (isLoggedIn === 'true') {
                loginScreen.style.display = 'none';
                app.style.display = 'block';
            }
            
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸæ—¥èªŒã‚’å–å¾—ã—ã¦è¡¨ç¤º
            loadSavedJournals();
            
            // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            loginBtn.addEventListener('click', function() {
                const password = document.getElementById('password').value;
                
                if (password === correctPassword) {
                    localStorage.setItem('logged_in', 'true');
                    loginScreen.style.display = 'none';
                    app.style.display = 'block';
                } else {
                    loginError.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                }
            });
            
            // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    const tabId = this.getAttribute('data-tab');
                    document.querySelectorAll('.container').forEach(container => {
                        container.style.display = 'none';
                    });
                    document.getElementById(tabId).style.display = 'block';
                });
            });
            
            // ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            quickInputButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetInput = document.getElementById(targetId);
                    const value = this.textContent;
                    
                    // ç¾åœ¨ã®å€¤ã¨æ–°ã—ã„å€¤ã‚’çµåˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
                    if (targetInput.value) {
                        targetInput.value = targetInput.value + 'ã€' + value;
                    } else {
                        targetInput.value = value;
                    }
                });
            });
            
            // éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆSpeechRecognition APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
            if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                voiceButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        const targetId = this.id.replace('voice-', '');
                        const targetInput = document.getElementById(targetId === 'mood' ? 'children-mood' : 'activities');
                        
                        const recognition = new SpeechRecognition();
                        recognition.lang = 'ja-JP';
                        recognition.interimResults = true;
                        
                        recognition.start();
                        this.textContent = 'ğŸ”´'; // éŒ²éŸ³ä¸­ã®è¡¨ç¤º
                        
                        recognition.onresult = function(event) {
                            const transcript = event.results[0][0].transcript;
                            if (event.results[0].isFinal) {
                                targetInput.value = transcript;
                            }
                        };
                        
                        recognition.onend = function() {
                            button.textContent = 'ğŸ¤'; // éŒ²éŸ³çµ‚äº†æ™‚ã®è¡¨ç¤º
                        };
                    });
                });
            } else {
                // SpeechRecognition APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                voiceButtons.forEach(button => {
                    button.style.display = 'none';
                });
            }
            
            // æ—¥èªŒç”Ÿæˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            generateBtn.addEventListener('click', async function() {
                // å…¥åŠ›å€¤ã®å–å¾—
                const date = document.getElementById('date').value;
                const weather = document.getElementById('weather').value;
                const classType = document.getElementById('class-type').value;
                const activities = document.getElementById('activities').value;
                const specialEvents = document.getElementById('special-events').value;
                const childrenMood = document.getElementById('children-mood').value;
                const keywords = document.getElementById('keywords').value;
                const length = document.getElementById('length').value;
                const apiKey = document.getElementById('api-key').value;
                const offlineMode = document.getElementById('offline-mode')?.value || 'auto';
                
                // å¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
                if (!date || !activities || !childrenMood) {
                    alert('æ—¥ä»˜ã€æ´»å‹•å†…å®¹ã€å­ã©ã‚‚ãŸã¡ã®æ§˜å­ã¯å¿…é ˆé …ç›®ã§ã™');
                    return;
                }
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                const isOffline = offlineMode === 'always' || 
                                (offlineMode === 'auto' && !navigator.onLine) || 
                                !apiKey;
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                document.getElementById('loading').style.display = 'block';
                document.getElementById('result-area').style.display = 'none';
                
                try {
                    let journalText = '';
                    
                    if (isOffline) {
                        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ç”Ÿæˆ
                        journalText = generateOfflineJournal(
                            date, weather, classType, activities, 
                            specialEvents, childrenMood, keywords
                        );
                        // æ“¬ä¼¼çš„ãªé…å»¶ã‚’è¿½åŠ ï¼ˆUXå‘ä¸Šã®ãŸã‚ï¼‰
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } else {
                        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: APIå‘¼ã³å‡ºã—
                        journalText = await callOpenAI(
                            apiKey, date, weather, classType, activities, 
                            specialEvents, childrenMood, keywords, length
                        );
                    }
                    
                    // çµæœã®è¡¨ç¤º
                    document.getElementById('result-text').textContent = journalText;
                    document.getElementById('result-area').style.display = 'block';
                    
                } catch (error) {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || 'åŸå› ä¸æ˜ã®ã‚¨ãƒ©ãƒ¼'}`);
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã§ç”Ÿæˆ
                    const fallbackText = generateOfflineJournal(
                        date, weather, classType, activities, 
                        specialEvents, childrenMood, keywords
                    );
                    document.getElementById('result-text').textContent = fallbackText;
                    document.getElementById('result-area').style.display = 'block';
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            // OpenAI APIã‚’å‘¼ã³å‡ºã™é–¢æ•°
            async function callOpenAI(apiKey, date, weather, classType, activities, specialEvents, childrenMood, keywords, length) {
                // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formattedDate = new Date(date).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä½œæˆ
                const prompt = `
ä»¥ä¸‹ã®æƒ…å ±ã‚’å…ƒã«ã€ä¿è‚²åœ’ã®æ—¥èªŒï¼ˆ${length}å­—ç¨‹åº¦ï¼‰ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚å€‹äººåã¯å«ã‚ãšã€ã‚¯ãƒ©ã‚¹å…¨ä½“ã®æ´»å‹•ã¨ã—ã¦è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚

æ—¥ä»˜: ${formattedDate}
å¤©å€™: ${weather}
ã‚¯ãƒ©ã‚¹: ${classType}
ä¸»ãªæ´»å‹•: ${activities}
${specialEvents ? `ç‰¹åˆ¥ãªå‡ºæ¥äº‹ãƒ»è¡Œäº‹: ${specialEvents}` : ''}
å­ã©ã‚‚ãŸã¡ã®æ§˜å­: ${childrenMood}
${keywords ? `ãã®ä»–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords}` : ''}

ä»¥ä¸‹ã®ç‚¹ã«æ³¨æ„ã—ã¦ä½œæˆã—ã¦ãã ã•ã„ï¼š
ãƒ»ä¿è‚²ã®å°‚é–€æ€§ãŒæ„Ÿã˜ã‚‰ã‚Œã‚‹è¡¨ç¾ã‚’ä½¿ã†
ãƒ»å­ã©ã‚‚ã®æ§˜å­ã‚’å…·ä½“çš„ã«æå†™ã™ã‚‹
ãƒ»ç™ºé”ã‚„å­¦ã³ã®è¦–ç‚¹ã‚’å«ã‚ã‚‹
ãƒ»ç´„${length}å­—ç¨‹åº¦ã«ã¾ã¨ã‚ã‚‹
`;
                
                // OpenAI APIå‘¼ã³å‡ºã—
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [
                            {
                                role: 'system',
                                content: 'ä¿è‚²åœ’ã®æ—¥èªŒã‚’ä½œæˆã™ã‚‹å°‚é–€å®¶ã¨ã—ã¦ã€å°‚é–€çš„ã‹ã¤å…·ä½“çš„ãªè¡¨ç¾ã§ä¿è‚²æ´»å‹•ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼: ${response.status}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content.trim();
            }
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®æ—¥èªŒã‚’ç”Ÿæˆ
            function generateOfflineJournal(date, weather, classType, activities, specialEvents, childrenMood, keywords) {
                // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formattedDate = new Date(date).toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    weekday: 'long'
                });
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ–‡ã®é…åˆ—
                const templates = [
                    `${formattedDate}ï¼ˆ${weather}ï¼‰ã®${classType}ã‚¯ãƒ©ã‚¹ã§ã¯ã€${activities}ã‚’è¡Œã„ã¾ã—ãŸã€‚å­ã©ã‚‚ãŸã¡ã¯${childrenMood}å–ã‚Šçµ„ã‚“ã§ã„ã¾ã—ãŸã€‚${specialEvents ? `ã¾ãŸã€${specialEvents}ã‚‚ã‚ã‚Šã€ç‰¹åˆ¥ãªä¸€æ—¥ã¨ãªã‚Šã¾ã—ãŸã€‚` : ''}${keywords ? `æ´»å‹•ã‚’é€šã—ã¦ã€${keywords}ãªã©ã®æˆé•·ãŒè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚` : ''}`,
                    
                    `ä»Šæ—¥ï¼ˆ${formattedDate}ï¼‰ã¯${weather}ã®ä¸­ã€${classType}ã‚¯ãƒ©ã‚¹ã®å­ã©ã‚‚ãŸã¡ã¯${childrenMood}${activities}ã«å–ã‚Šçµ„ã¿ã¾ã—ãŸã€‚${specialEvents ? `${specialEvents}ã§ã¯ã€æ™®æ®µã¨ã¯é•ã†è¡¨æƒ…ã‚‚è¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚` : ''}å­ã©ã‚‚ãŸã¡åŒå£«ã®é–¢ã‚ã‚Šã‚‚å¢—ãˆã€å”èª¿æ€§ã‚„ç¤¾ä¼šæ€§ãŒè‚²ã¾ã‚Œã¦ã„ã¾ã™ã€‚${keywords ? `ç‰¹ã«${keywords}ã®é¢ã§æˆé•·ãŒæ„Ÿã˜ã‚‰ã‚Œã¾ã—ãŸã€‚` : ''}`,
                    
                    `${weather}ã®${formattedDate}ã€${classType}ã‚¯ãƒ©ã‚¹ã§ã¯${activities}ã‚’ä¸­å¿ƒã«æ´»å‹•ã—ã¾ã—ãŸã€‚å­ã©ã‚‚ãŸã¡ã¯${childrenMood}æ´»å‹•ã«å‚åŠ ã—ã€æ„æ¬²çš„ãªå§¿ãŒè¦‹ã‚‰ã‚Œã¾ã—ãŸã€‚${specialEvents ? `${specialEvents}ã‚‚å®Ÿæ–½ã—ã€å­ã©ã‚‚ãŸã¡ã®æ–°ãŸãªä¸€é¢ã‚’ç™ºè¦‹ã§ãã¾ã—ãŸã€‚` : ''}äº’ã„ã«åˆºæ¿€ã—åˆã„ãªãŒã‚‰ã€${keywords ? `${keywords}ãªã©ã€` : ''}æ§˜ã€…ãªåŠ›ã‚’ä¼¸ã°ã—ã¦ã„ã¾ã™ã€‚`
                ];
                
                // ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠ
                const randomIndex = Math.floor(Math.random() * templates.length);
                return templates[randomIndex];
            }
            
            // æ—¥èªŒã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
            function saveJournal(date, classType, text) {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ—¢å­˜ã®ä¿å­˜æ¸ˆã¿æ—¥èªŒã‚’å–å¾—
                const savedJournals = JSON.parse(localStorage.getItem('saved_journals') || '[]');
                
                // æ–°ã—ã„æ—¥èªŒã‚’è¿½åŠ 
                savedJournals.push({
                    id: Date.now().toString(),
                    date: date,
                    classType: classType,
                    text: text,
                    createdAt: new Date().toISOString()
                });
                
                // ä¿å­˜ï¼ˆæ–°ã—ã„é †ã«ã‚½ãƒ¼ãƒˆï¼‰
                savedJournals.sort((a, b) => new Date(b.date) - new Date(a.date));
                localStorage.setItem('saved_journals', JSON.stringify(savedJournals));
            }
            
            // ä¿å­˜æ¸ˆã¿æ—¥èªŒã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
            function loadSavedJournals() {
                const savedJournals = JSON.parse(localStorage.getItem('saved_journals') || '[]');
                const container = document.getElementById('saved-journals-list');
                
                if (savedJournals.length === 0) {
                    container.innerHTML = '<p>ä¿å­˜ã—ãŸæ—¥èªŒã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    return;
                }
                
                container.innerHTML = '';
                
                savedJournals.forEach(journal => {
                    const formattedDate = new Date(journal.date).toLocaleDateString('ja-JP', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    const journalItem = document.createElement('div');
                    journalItem.className = 'journal-item';
                    journalItem.innerHTML = `
                        <div class="journal-date">${formattedDate} (${journal.classType})</div>
                        <div class="journal-preview">${journal.text.substring(0, 50)}...</div>
                    `;
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º
                    journalItem.addEventListener('click', function() {
                        document.getElementById('result-text').textContent = journal.text;
                        document.getElementById('result-area').style.display = 'block';
                        
                        // ä½œæˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
                        tabButtons.forEach(btn => {
                            if (btn.getAttribute('data-tab') === 'create-tab') {
                                btn.click();
                            }
                        });
                        
                        // ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                        document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });
                    });
                    
                    container.appendChild(journalItem);
                });
            }
            
            // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹ã‚’ç›£è¦–
            window.addEventListener('online', function() {
                const offlineMode = localStorage.getItem('offline_mode') || 'auto';
                if (offlineMode === 'auto') {
                    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸã“ã¨ã‚’é€šçŸ¥
                    if (document.getElementById('settings-tab').style.display !== 'block') {
                        alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ä½¿ç”¨ã§ãã¾ã™ã€‚');
                    }
                }
            });
            
            window.addEventListener('offline', function() {
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã«ãªã£ãŸã“ã¨ã‚’é€šçŸ¥
                alert('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
            });
            
            // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’PWAã¨ã—ã¦ç™»éŒ²ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ç™»éŒ²
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('service-worker.js')
                        .then(function(registration) {
                            console.log('ServiceWorkerç™»éŒ²æˆåŠŸ:', registration.scope);
                        })
                        .catch(function(error) {
                            console.log('ServiceWorkerç™»éŒ²å¤±æ•—:', error);
                        });
                });
            }
        });
    </script>
</body>
</html>
getElementById('offline-mode')?.value || 'auto';
                
                // å¿…é ˆé …ç›®ã®ãƒã‚§ãƒƒã‚¯
                if (!date || !activities || !childrenMood) {
                    alert('æ—¥ä»˜ã€æ´»å‹•å†…å®¹ã€å­ã©ã‚‚ãŸã¡ã®æ§˜å­ã¯å¿…é ˆé …ç›®ã§ã™');
                    return;
                }
                
                // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
                const isOffline = offlineMode === 'always' || 
                                 (offlineMode === 'auto' && !navigator.onLine) || 
                                 !apiKey;
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
                document.getElementById('loading').style.display = 'block';
                document.getElementById('result-area').style.display = 'none';
                
                try {
                    let journalText = '';
                    
                    if (isOffline) {
                        // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã®ç”Ÿæˆ
                        journalText = generateOfflineJournal(
                            date, weather, classType, activities, 
                            specialEvents, childrenMood, keywords
                        );
                        // æ“¬ä¼¼çš„ãªé…å»¶ã‚’è¿½åŠ ï¼ˆUXå‘ä¸Šã®ãŸã‚ï¼‰
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } else {
                        // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰: APIå‘¼ã³å‡ºã—
                        journalText = await callOpenAI(
                            apiKey, date, weather, classType, activities, 
                            specialEvents, childrenMood, keywords, length
                        );
                    }
                    
                    // çµæœã®è¡¨ç¤º
                    document.getElementById('result-text').textContent = journalText;
                    document.getElementById('result-area').style.display = 'block';
                    
                } catch (error) {
                    console.error('ã‚¨ãƒ©ãƒ¼:', error);
                    alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message || 'åŸå› ä¸æ˜ã®ã‚¨ãƒ©ãƒ¼'}`);
                    
                    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ™ãƒ¼ã‚¹ã§ç”Ÿæˆ
                    const fallbackText = generateOfflineJournal(
                        date, weather, classType, activities, 
                        specialEvents, childrenMood, keywords
                    );
                    document.getElementById('result-text').textContent = fallbackText;
                    document.getElementById('result-area').style.display = 'block';
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            copyBtn.addEventListener('click', function() {
                const text = document.getElementById('result-text').textContent;
                
                // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                if (navigator.clipboard) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            alert('æ–‡ç« ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                        })
                        .catch(err => {
                            alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
                        });
                } else {
                    // Clipboardã«å¯¾å¿œã—ã¦ã„ãªã„å ´åˆï¼ˆéå¯¾å¿œã®iPadOSãªã©ï¼‰
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    textArea.style.position = 'fixed';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        alert('æ–‡ç« ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                    } catch (err) {
                        alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err);
                    }
                    
                    document.body.removeChild(textArea);
                }
            });
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            saveBtn.addEventListener('click', function() {
                const date = document.getElementById('date').value;
                const classType = document.getElementById('class-type').value;
                const text = document.getElementById('result-text').textContent;
                
                // æ—¥èªŒã‚’ä¿å­˜
                saveJournal(date, classType, text);
                alert('æ—¥èªŒã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                
                // ä¿å­˜æ¸ˆã¿ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                loadSavedJournals();
            });
            
            // è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            saveSettingsBtn.addEventListener('click', function() {
                const apiKey = document.getElementById('api-key').value;
                localStorage.setItem('openai_api_key', apiKey);
                
                const offlineMode = document.